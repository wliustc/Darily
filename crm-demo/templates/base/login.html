{#<!DOCTYPE html>#}
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6 lt8"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7 lt8"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8 lt8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html lang="zh" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="UTF-8"/>
    <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">  -->
    <link rel="shortcut icon" type="text/css" href="/static/img/ooopic_1540555990.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/css/demo.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/style3.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/animate-custom.css"/>
    <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.css">
</head>
<body>
<div class="container" style="margin-top: 80px">
    <section>
        <div id="container_demo">
            <a class="hiddenanchor" id="toregister"></a>
            <a class="hiddenanchor" id="tologin"></a>
            <div id="wrapper">
                <div id="login" class="animate form">
                    <form action="{% url 'login' %}" autocomplete="on" method="post">
                        {% csrf_token %}
                        <h1> Log in </h1>
                        <p>
                            <label for="username" class="uname" data-icon="u"> 用户名</label>
                            <input id="username" class="sp" name="username" required="required" type="text" style="margin-top: 0"
                                   placeholder="myusername or mymail@mail.com"/>
                        </p>
                        <p>
                            <label for="password" class="youpasswd" data-icon="p"> 密码 </label>
                            <input id="password" name="password" class="sp" required="required" type="password" style="margin-top: 0"
                                   placeholder="eg. X8df!90EO"/>
                            <span style="float: right;color:#f00;font-size: 12px"
                                  class="span_err"></span>
                        </p>

                        <p class="keeplogin" style="margin-top: 20px;">
                            <input type="checkbox" name="loginkeeping" id="loginkeeping" value="loginkeeping"/>
                            <label for="loginkeeping">保持登录</label>
                        </p>
                        <p>
                            <span class="col-md-4">
                                <label for="" class=""> 验证码 </label>
                                <input id="code" name="code" required="required" style="margin-top: 0"  type="text"/>
                            </span>

                            <span class="col-md-4 col-md-offset-3" id="im" style="margin-top: 25px">
                                <img width="130" height="40" src="/get_valid_img/" alt="" id="img">
                            </span>
                            <span class="span_code col-md-8 col-md-offset-2" style="float: left;color:#f00;font-size: 12px"></span>
                        </p>

                        <p class="login button" style="margin-top: 100px">
                            <input type="button" class="login_btn" value="登录"/>
                        </p>
                        <p>
                            <a href="{% url 'home' %}" class="to_register" style="text-decoration: none"> 返回 </a>
                        </p>
                        <p class="change_link">
                            还没有账号 ?
                            {#                            <a href="{% url 'register' %}" class="to_register">立即注册</a>#}
                            <a href="#toregister" class="to_register">立即注册</a>
                        </p>
                    </form>
                </div>

                <div id="register" class="animate form">
                    <form action="" autocomplete="on" method="post" novalidate>
                        {% csrf_token %}
                        <h1> Sign up </h1>
                        <p>
                            <label for="usernamesignup" class="uname" data-icon="u">昵称</label>
                            <input id="usernamesignup" name="username" required="required" type="text" class="input1"
                                   style="margin-top: 0" placeholder="username"/>
                            <span style="float: right;color:#f00;font-size: 12px"
                                  class="span1">{{ errors.username.0 }}</span>
                        </p>

                        <p class="b">
                            <label for="emailsignup" class="youmail" data-icon="e"> 邮箱</label>
                            <input id="emailsignup" name="email" required="required" type="email" class="input2"
                                   style="margin-top: 0" placeholder="mymail@mail.com"/>
                            <span style="float: right;color:#f00;font-size: 12px"
                                  class="span2">{{ errors.email.0 }}</span>
                        </p>

                        <p>
                            <label for="passwordsignup" class="youpasswd" data-icon="p">密码</label>
                            <input id="passwordsignup" name="password" required="required" type="password"
                                   class="input3" style="margin-top: 0"
                                   placeholder="eg. X8df!90EO"/>
                            <span style="float: right;color:#f00;font-size: 12px"
                                  class="span3">{{ errors.password.0 }}</span>
                        </p>

                        <p>
                            <label for="passwordsignup_confirm" class="youpasswd" data-icon="p">请再次输入您的密码 </label>
                            <input id="passwordsignup_confirm" name="r_pwd" required="required" class="input4"
                                   style="margin-top: 0" type="password" placeholder="eg. X8df!90EO"/>
                            <span style="float: right;color:#f00;font-size: 12px"
                                  class="span4">{{ errors.pwd.0 }}</span>
                            <span style="float: right;color:#f00;font-size: 12px"
                                  class="span4 span5">{{ g_error|default:"" }}</span>
                        </p>
                        <p class="signin button" style="margin-top: 30px">
                            <input type="button" class="reg" value="注册"/>
                        </p>
                        <p>
                            <a href="{% url 'home' %}" class="to_register" style="text-decoration: none"> 返回 </a>
                        </p>
                        <p class="change_link">
                            已有账号 ?
                            {#                            <a href="{% url 'login' %}" class="to_register"> 直接登录 </a>#}
                            <a href="#tologin" class="to_register"> 直接登录 </a>
                        </p>
                    </form>
                </div>

            </div>
        </div>
    </section>
</div>
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<script src="/static/bootstrap/js/jquery.js"></script>
<!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
<script src="/static/bootstrap/js/bootstrap.js"></script>

<script>
    $('.input1').focusin(function () {
        $('.span1').html('');
        $(this).val('');
    });
    $('.input2').focusin(function () {
        $('.span2').html('');
        $(this).val('');
    });
    $('.input3').focusin(function () {
        $('.span3').html('');
        $(this).val('');
    });
    $('.input4').focusin(function () {
        $('.span4').html('');
        $(this).val('');
    });

    $('.sp').focusin(function () {
        $(".span_err").html('');
    });

    $('.reg').on('click', function () {
        $.ajax({
            url: '{% url 'register' %}',
            type: 'post',
            data: {
                csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val(),
                username: $(".input1").val(),
                email: $(".input2").val(),
                password: $(".input3").val(),
                r_pwd: $(".input4").val(),
            },
            success: function (response) {
                let obj = response;
                console.log(obj.state);
                if (obj.state == 1003) {
                    location.href = "{% url 'register' %}";
                } else {
                    if (obj.state == 1001) {
                        alert('注册成功!点击确认跳转登录界面');
                        location.href = "{% url 'login' %}";
                    }
                    if (obj.state == 1002) {

                        $('.span1').html(obj.username_error);
                        $('.span2').html(obj.email_error);
                        $('.span3').html(obj.password_error);
                        $('.span4').html(obj.r_pwd);
                        $('.span5').html(obj.g_error);
                        console.log(obj.username_error);
                        console.log(obj.email_error);
                        console.log(obj.password_error);
                        console.log(obj.r_pwd);
                        console.log(obj.g_error);
                    }
                }
            },
            error: function (err) {
                console.log(err)
            }
        })
    });

    $(".login_btn").click(function () {

        $.ajax({
            url: "{% url 'login' %}",
            type: "post",
            data: {
                username: $("#username").val(),
                password: $("#password").val(),
                code: $("#code").val(),
                csrfmiddlewaretoken: $("[name='csrfmiddlewaretoken']").val()
            },
            success: function (response) {

                console.log(response);
                if (response.user) {
                    // 登录成功
                    if(location.search.slice(6)){
                             location.href=location.search.slice(6)
                         }
                         else{
                             location.href="/"
                         }
                }
                else {
                    // 登录失败
                    $(".span_err").html(response.err_user);
                    $(".span_code").html(response.err_code);
                }
            }
        })


    });

    //  验证码刷新
    $("#img").click(function () {
        this.src += "?"
    });

    $('#code').focusin(function () {
        let ret = $('#img').attr('src') + '?';
        $('#img').attr('src', ret);
        $(".span_code").html('');
        $(this).val('');
    });
</script>
</body>
</html>